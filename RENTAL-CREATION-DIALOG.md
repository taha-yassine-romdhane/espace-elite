# Rental Creation Dialog Documentation

## Overview
A streamlined **multi-step wizard** for creating new rentals with accessories from the employee dashboard.

## Location
- **Component**: `src/components/dialogs/RentalCreationDialog.tsx`
- **Article Selection Dialog**: `src/components/dialogs/RentalArticleSelectionDialog.tsx`
- **Integrated in**: `src/pages/roles/employee/dashboard/index.tsx`

## Features

### Multi-Step Process (4 Steps)

#### **Step 1: Patient Selection** üë§
- Inline patient list with search functionality
- Search by name, code, or phone number
- Scrollable patient cards with full details
- Auto-advance to Step 2 on selection
- Visual confirmation when patient is selected
- Required to proceed

#### **Step 2: Article Selection** üì¶ü©∫
- Big prominent selection button opens RentalArticleSelectionDialog
- **Two-tab interface:**
  - **Appareils M√©dicaux** - Medical devices only (excludes diagnostic devices)
  - **Accessoires** - Accessories only (excludes spare parts)
- Medical device selection (single select, auto-close)
- Accessory selection (multi-select with confirmation)
- Visual display of selected device and accessories
- Quantity adjustment and removal for accessories
- Total accessories cost calculation
- Required to select at least one medical device

#### **Step 3: Rental Configuration** ‚öôÔ∏è
**Required Fields:**
- Start Date - Date picker (defaults to today)
- Rental Rate - Numeric input with DT currency
- Billing Cycle - Dropdown selector:
  - Par jour (DAILY)
  - Par semaine (WEEKLY)
  - Par mois (MONTHLY)

**Optional Fields:**
- End Date - Date picker (disabled when "open-ended" is checked)
- Open-Ended Toggle - Switch to mark rental as indefinite
- Status - Initial rental status:
  - En attente (PENDING) - default
  - Actif (ACTIVE)
  - Suspendu (PAUSED)
- CNAM Eligible - Toggle for CNAM reimbursement eligibility

#### **Step 4: Review & Summary** ‚úÖ
- Complete overview of all entered data:
  - Patient name
  - Medical device name
  - Start/end dates
  - Rental rate and billing cycle
  - Status and CNAM eligibility
  - List of all accessories with quantities and prices
  - Total accessories cost
- Final confirmation before creation

### Auto-Populated Fields
- **Created By** - Automatically set to logged-in employee
- **Assigned To** - Automatically set to logged-in employee
- **Rental Code** - Auto-generated by API in format: `LOC-YYYY-XXXX`

## User Experience Features

### Visual Progress Indicator
- Sidebar navigation showing all 4 steps
- Completed steps show green checkmarks
- Current step is highlighted in green with active state
- Future steps are grayed out and disabled
- Each step shows summary of selected data

### Navigation
- **Sidebar buttons** - Click to jump back to completed steps
- **Suivant** (Next) button - advances to next step after validation
- **Pr√©c√©dent** (Back) button - returns to previous step (appears from step 2)
- **Annuler** (Cancel) button - closes dialog and resets form
- Final step shows **"Cr√©er la Location"** button

### Validation
- Each step validates required fields before allowing progression
- Clear error messages if validation fails
- "Suivant" button disabled when required fields are empty
- Step 2 requires at least one medical device

## Usage

### From Employee Dashboard
1. Click **"Commencer une Location"** button
2. **Step 1**: Search and select patient ‚Üí Auto-advance to Step 2
3. **Step 2**: Click big selection button ‚Üí Choose medical device and accessories ‚Üí Click "Suivant"
4. **Step 3**: Configure rental (dates, rate, billing) ‚Üí Click "Suivant"
5. **Step 4**: Review summary ‚Üí Click "Cr√©er la Location"

### Selecting Articles (Step 2)
1. Click the big **"S√©lectionner Appareil & Accessoires"** button
2. **RentalArticleSelectionDialog** opens with two tabs:
   - **Appareils M√©dicaux** - Shows only medical devices (excludes diagnostics, excludes already rented)
   - **Accessoires** - Shows only accessories (excludes spare parts)
3. **To select medical device:**
   - Switch to "Appareils M√©dicaux" tab
   - Search by code, name, brand, model, or serial number
   - Click on a device card ‚Üí Dialog auto-closes
4. **To select accessories:**
   - Switch to "Accessoires" tab
   - Search by code, name, brand, or model
   - Click on accessory cards to multi-select
   - Click "Confirmer la s√©lection" button
5. Back on Step 2, adjust quantities for accessories
6. Remove device or accessories with X button if needed

## API Integration

### Rental Creation
**Endpoint**: `POST /api/rentals/comprehensive`

**Request Body**:
```json
{
  "patientId": "string",
  "medicalDeviceId": "string",
  "startDate": "YYYY-MM-DD",
  "endDate": "YYYY-MM-DD" | null,
  "status": "PENDING" | "ACTIVE" | "PAUSED",
  "createdById": "string",
  "assignedToId": "string",
  "configuration": {
    "rentalRate": number,
    "billingCycle": "DAILY" | "WEEKLY" | "MONTHLY",
    "isGlobalOpenEnded": boolean,
    "cnamEligible": boolean
  }
}
```

### Accessories Creation
**Endpoint**: `POST /api/rental-accessories` (for each accessory)

**Request Body**:
```json
{
  "rentalId": "string",
  "productId": "string",
  "quantity": number,
  "unitPrice": number
}
```

**Flow**:
1. Create rental first
2. If successful and accessories exist, create each accessory link
3. If accessory creation fails, show warning but rental is still created
4. Invalidate queries to refresh data

## Component Props

```typescript
interface RentalCreationDialogProps {
  open: boolean;                        // Control dialog visibility
  onOpenChange: (open: boolean) => void; // Callback when dialog opens/closes
  onSuccess?: (rentalId: string) => void; // Optional callback after successful creation
}
```

## State Management

### Form State
- Patient selection (id, name, code, phone)
- Medical device selection (id, name, code)
- Rental configuration (dates, rate, cycle, status, CNAM)
- Accessories array (type, id, name, code, brand, model, quantity, unitPrice, totalPrice)
- Current step (1-4)
- Article dialog visibility state

### Validation State
- Step 1: Patient must be selected before proceeding
- Step 2: Medical device must be selected (at least one) before proceeding
- Step 3: Start date and rental rate > 0 required before proceeding
- Step 4: Always allowed (review step, no additional validation)

## Example Usage

```tsx
import { RentalCreationDialog } from "@/components/dialogs/RentalCreationDialog";

function MyComponent() {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <>
      <button onClick={() => setIsOpen(true)}>
        Create Rental
      </button>

      <RentalCreationDialog
        open={isOpen}
        onOpenChange={setIsOpen}
        onSuccess={(rentalId) => {
          console.log('Rental created:', rentalId);
          // Optional: navigate to rental details page
        }}
      />
    </>
  );
}
```

## Design Decisions

### Why Multi-Step Wizard?
- **Reduced Cognitive Load**: One focus area at a time
- **Clear Progress**: Sidebar navigation shows all steps with summaries
- **Better Validation**: Validate incrementally, not all at once
- **Jump Back Ability**: Users can easily navigate to previous steps
- **Professional UX**: Matches modern SaaS application patterns (similar to sale creation)

### Why These 4 Steps?
1. **Patient** - Core requirement, sets context for the entire rental
2. **Articles** - Combined device + accessories selection (main rental items)
3. **Configuration** - Multiple related rental settings grouped together
4. **Review** - Final check with complete summary before commitment

### Why Combine Device + Accessories in Step 2?
- **Related Items**: Both are the physical items being rented
- **Single Context**: User is in "selection mode" for all rental items
- **Reduced Steps**: More efficient than separating device and accessories
- **Clear Purpose**: Dedicated step for "what are we renting?"
- **Better UX**: Big selection button with custom dialog feels intentional

### Why Custom RentalArticleSelectionDialog?
- **Rental-Specific Filtering**: Only medical devices (not diagnostics), only accessories (not spare parts)
- **Different Selection Patterns**: Device is single-select (auto-close), accessories are multi-select (with confirmation)
- **Stock Awareness**: Shows stock quantities and availability
- **Search Functionality**: Built-in search for each tab
- **Visual Clarity**: Tab-based interface makes it clear what can be selected
- **Prevents Errors**: Only allows appropriate item types for rentals

### Why Direct Patient List in Step 1?
- **Faster Selection**: No extra dialog click required
- **Better Search**: Real-time filtering as you type
- **Full Context**: See all patient details before selecting
- **Auto-Advance**: Immediately moves to Step 2 after selection

## Success Flow

1. User completes all 4 steps
2. Reviews summary in Step 4
3. Clicks "Cr√©er la Location"
4. Rental is created via API (rental code auto-generated)
5. Accessories are linked to rental (if any were selected)
6. Queries invalidated to refresh data
7. Success toast shows rental code
8. Dialog closes and resets to Step 1
9. Optional `onSuccess` callback fires with rental ID

## Error Handling

- **Step Validation**: Error toast if required fields missing
- **Rental Creation Failed**: Error toast with API error message
- **Accessories Failed**: Warning toast (rental still created)
- **Device Required**: Error toast if trying to proceed from Step 2 without selecting a device

## Related Components
- `RentalArticleSelectionDialog` - Custom dialog for selecting medical devices and accessories (Step 2)
- `ComprehensiveRentalsTable` - Full rental management table (for viewing/editing existing rentals)
- React Query hooks for fetching patients, devices, and accessories
- `useToast` for user feedback
- `useMutation` for rental creation API calls

## Future Enhancements

Possible additions:
- Delivery notes field (Step 3)
- Internal notes field (Step 3)
- Upload attachment support (Step 5)
- Assign to different employee option (Step 3)
- Bulk rental creation
- Rental templates/presets
- Save as draft feature
- Skip to step navigation (after initial completion)
